<!-- JSPM -->
<script src="/asset/javascript/jspm_packages/system.js"></script>
<script> System.config({ baseURL: "/asset/javascript/" }); </script>
<script src="/asset/javascript/jspm.config.js"></script>

<!-- Load Custom Elements es5 adapter - Fixing (supposedly) workaround ES5-style classes cannot properly extend ES6 classes - https://github.com/webcomponents/webcomponentsjs#custom-elements-es5-adapterjs --> 
<!--<script src="/asset/webcomponent/bower_components/webcomponentsjs/custom-elements-es5-adapter.js"></script>
<script src="/asset/webcomponent/bower_components/webcomponentsjs/webcomponents-loader.js"></script>-->

<script>
// SZN App global class
{
    let AppFrontEnd = JSON.parse('{%= JSON.stringify(Application.frontend) %}');
    // Initialize the window object 'App' That will contain all utility functions and behaviors for the app //
    class AppClass {
        constructor() {
        }
    } 
    // Global Object that handles the app and other stuff.
    window.App = AppFrontEnd || new AppClass();
    let App = window.App
    App.module = App.module || {}; // polymer behaviors that include functions and properties.

    let settingBehavior = { // Setting behavior for the app.
        properties: {
            setting: {
                type: Object,
                value: () => {
                    return {
                        location: {
                            routeBasePath: `${App.config.PROTOCOL}${App.config.HOST}`
                        }
                    }
                },
                notify: true,
                reflectToAttribute: true,
            },
            document: {
                type: Array,
                value: () => {
                    return [
                        {
                            key: 'homepage',
                            entrypointTree: 'webapp-layout-list'
                        },
                        {
                            key: 'webapp-layout-toolbar',
                            entrypointTree: 'webapp-layout-toolbar'
                        },

                    ]
                },
                notify: true,
                reflectToAttribute: true,
            },
        },
    };
    App.behavior = App.behavior || {}; // polymer behaviors that include functions and properties.
    App.behavior.setting = settingBehavior
    // System.import('setting.behavior.js').then(exports => window.App.behavior.setting = exports.default);
    // Mixins are not supported curretly by Polymer, and babel as a side effect of hacks created.
    // window.App.mixin = window.App.mixin || {};
    // System.import('setting.mixin.js').then(exports => window.App.mixin.setting = exports.default);

    // class MixinBuilder {  
    //     constructor(superclass) {
    //         this.superclass = superclass;
    //     }

    //     with(...mixins) { 
    //         return mixins.reduce((c, mixin) => mixin(c), this.superclass);
    //     }
    // }
    // window.App.module.Mixin = (superclass) => new MixinBuilder(superclass);   
}
</script>    

<script>    
// Polymer settings, Polyfill
{
    // Load Polymer (importing through the bower using the first webcomponent to be imported to the document, which includes `../polymer/polymer.html` import) 
    // NOTE: Problem that it is executed after the below code.
    // System.import('polymer@2.0-preview/polymer.html!')
    // System.import('http://cdn.localhost/asset/webcomponent/bower_components/polymer/polymer.html!')

    // Web performance API
    window.performance && performance.mark && performance.mark('entrypoint.html');

    // Load webcomponentsjs polyfill if browser does not support native Web Components
    let onload = () => {
        // For native Imports, manually fire WebComponentsReady so user code
        // can use the same code path for native and polyfill'd imports.
        if (!window.HTMLImports) {
            document.dispatchEvent(
                new CustomEvent('WebComponentsReady', {bubbles: true})
            );
        }
    };
    let webComponentsSupported = (
        'registerElement' in document
        && 'import' in document.createElement('link')
        && 'content' in document.createElement('template')
    );
    if (!webComponentsSupported) {
        console.info('☕ Polyfill webcomponents. Loading webcomponents javascript.')
        let script = document.createElement('script');
        script.async = true;
        script.src = '/asset/webcomponent/bower_components/webcomponentsjs/webcomponents-loader.js';
        script.onload = onload;
        document.head.appendChild(script);
        // load tag 1.0.0-rc.4
        // JSPM Causes `detected as amd but didn't execute correctly.` which needs configuration. Using bower istead.
        // System.import('webcomponentsjs/webcomponents-lite.js')
    } else {
        console.info('☕ Native webcomponents. Dispaching \'WebComponentsReady\' event manually.')
        window.addEventListener('load', () => { // inorder for the event listener to be registered before dispatching it.
            onload();
        })
    }
}
</script>    

<script>    
// Service Worker
{
    let App = window.App
    // Load pre-caching Service Worker
    navigator.serviceWorker && window.addEventListener('load', function() {
            navigator.serviceWorker.register(`${window.location.origin}/serviceWorker.js`, {scope: `${App.config.PROTOCOL}${App.config.HOST}/`}).then(registration => {
                console.log(`☕ Service Worker - registered with scope: ${registration.scope}`)
            })
    });
}
</script>